name: Build Android APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet
          # ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          # Fletã®è¦æ±‚ã«åˆã‚ã›ã¦å°‘ã—æ–°ã—ã‚ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
          flutter-version: '3.29.2'
          channel: 'stable'

      - name: Accept Android Licenses
        run: yes | flutter doctor --android-licenses

      - name: Build APK
        run: |
          # 1. ã‚¢ãƒ—ãƒªã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã¸ç¢ºå®Ÿã«ç§»å‹•
          if [ -d "src/gymkhana_mobile" ]; then
            cd src/gymkhana_mobile
            echo "ğŸ“‚ Working directory: $(pwd)"
          else
            echo "âŒ src/gymkhana_mobile not found!"
            exit 1
          fi

          # 2. main.py ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª (Fletãƒ“ãƒ«ãƒ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
          if [ ! -f "main.py" ]; then
            if [ -f "app.py" ]; then
              mv app.py main.py
              echo "ğŸ”„ Renamed app.py to main.py"
            else
              echo "âŒ main.py or app.py not found in $(pwd)"
              ls -l
              exit 1
            fi
          fi

          # 3. æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º (ãƒ‡ãƒãƒƒã‚°ç”¨)
          echo "ğŸ“¦ Current files for packaging:"
          ls -F

          # 4. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          # ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: --yes ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ã—ã¦å¯¾è©±å‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å›é¿
          # ã“ã‚Œã«ã‚ˆã‚Šã€SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèªãªã©ã§æ­¢ã¾ã‚‹ã“ã¨ãªããƒ“ãƒ«ãƒ‰ãŒé€²ã¿ã¾ã™
          flet build apk --verbose --yes

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          # ã™ã¹ã¦ã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰apkã‚’æ¢ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          path: "**/build/apk/*.apk"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # ãƒªãƒªãƒ¼ã‚¹ã«ã¯å®Œæˆã—ãŸAPKã®ã¿ã‚’æ·»ä»˜
          files: "**/build/apk/app-release.apk"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
